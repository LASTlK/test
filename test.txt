import { useState, useEffect } from "react";
import Sidebar from "./Sidebar";
import Header from "./Header";
import { useAuth } from "../context/AuthContext";
import axios from "axios";

import NewsIcon from "../assets/icon/news-icon.svg";
import PlusIcon from "../assets/icon/plus-icon-brown.svg";
import PlusImageIcon from "../assets/icon/plus-image-icon.svg"; // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏–∫–æ–Ω–∫–∞ –µ—Å—Ç—å
import NewsImage from "../assets/images/news1.jpg";

const NewsPage = () => {
  const [isAddingNews, setIsAddingNews] = useState(false);
  const [editingNews, setEditingNews] = useState(null);
  const [formData, setFormData] = useState({
    title: "",
    content: "",
    image: null,
    category: "general",
    is_published: true,
  });
  const [newsList, setNewsList] = useState([]);
  const [loading, setLoading] = useState(false);
  const [imagePreview, setImagePreview] = useState(null);
  const { user, isAuthenticated } = useAuth();

  // –ë–∞–∑–æ–≤—ã–µ URL
  const DJANGO_API = 'http://localhost:8000/news/api';
  const DJANGO_MEDIA = 'http://localhost:8000/media';

  // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π
  useEffect(() => {
    fetchNews();
  }, []);

  const fetchNews = async () => {
    try {
      setLoading(true);
      console.log('üîç –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–≤–æ—Å—Ç–∏...');
      
      const response = await axios.get(`${DJANGO_API}/news/public/`);
      console.log('üì∞ –ü–æ–ª—É—á–µ–Ω–æ –Ω–æ–≤–æ—Å—Ç–µ–π:', response.data.length);
      
      if (response.data.length > 0) {
        const firstNews = response.data[0];
        console.log('üìä –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–∏:', {
          id: firstNews.id,
          title: firstNews.title,
          image_url: firstNews.image_url,
          has_image: !!firstNews.image
        });
      }
      
      setNewsList(response.data || []);
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
      console.error('–°—Ç–∞—Ç—É—Å:', error.response?.status);
      console.error('–î–∞–Ω–Ω—ã–µ:', error.response?.data);
      setNewsList([]);
    } finally {
      setLoading(false);
    }
  };

  const handleInputChange = (e) => {
    const { name, value, type, checked } = e.target;
    setFormData(prev => ({ 
      ...prev, 
      [name]: type === 'checkbox' ? checked : value 
    }));
  };

  const handleFileChange = (e) => {
    if (e.target.files.length > 0) {
      const file = e.target.files[0];
      console.log('üìÅ –í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª:', file.name, file.size, file.type);
      
      setFormData(prev => ({ ...prev, image: file }));
      
      // –°–æ–∑–¥–∞–µ–º preview
      const reader = new FileReader();
      reader.onloadend = () => {
        setImagePreview(reader.result);
      };
      reader.readAsDataURL(file);
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    if (!isAuthenticated) {
      alert('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
      return;
    }
    
    try {
      setLoading(true);
      const token = localStorage.getItem('access_token');
      console.log('üîë –¢–æ–∫–µ–Ω:', token ? '–ï—Å—Ç—å' : '–ù–µ—Ç');
      
      // –°–æ–∑–¥–∞–µ–º FormData
      const formDataToSend = new FormData();
      formDataToSend.append('title', formData.title);
      formDataToSend.append('content', formData.content);
      formDataToSend.append('category', formData.category);
      formDataToSend.append('is_published', formData.is_published);
      
      if (formData.image instanceof File) {
        formDataToSend.append('image', formData.image);
        console.log('üì§ –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ FormData:', formData.image.name);
      } else if (editingNews && formData.image === null) {
        // –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏, –µ—Å–ª–∏ image —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ null - —É–¥–∞–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        formDataToSend.append('image', '');
      }
      
      console.log('üì® –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ...');

      const config = {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'multipart/form-data'
        }
      };

      let url, method;
      if (editingNews) {
        url = `${DJANGO_API}/news/${editingNews.id}/`;
        method = 'put';
        console.log('‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –Ω–æ–≤–æ—Å—Ç—å ID:', editingNews.id);
      } else {
        url = `${DJANGO_API}/news/`;
        method = 'post';
        console.log('‚ûï –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –Ω–æ–≤–æ—Å—Ç—å');
      }

      const response = await axios[method](url, formDataToSend, config);
      console.log('‚úÖ –£—Å–ø–µ—à–Ω–æ! –û—Ç–≤–µ—Ç:', response.data);

      // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
      await fetchNews();
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
      resetForm();
      
      alert(editingNews ? '–ù–æ–≤–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞!' : '–ù–æ–≤–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
      console.error('–°—Ç–∞—Ç—É—Å:', error.response?.status);
      console.error('–î–∞–Ω–Ω—ã–µ:', error.response?.data);
      console.error('Headers:', error.response?.headers);
      
      if (error.response?.status === 401) {
        alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.');
      } else if (error.response?.status === 400) {
        alert('–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö: ' + JSON.stringify(error.response?.data));
      } else {
        alert('–û—à–∏–±–∫–∞: ' + (error.response?.data?.detail || error.message));
      }
    } finally {
      setLoading(false);
    }
  };

  const resetForm = () => {
    setFormData({
      title: "",
      content: "",
      image: null,
      category: "general",
      is_published: true,
    });
    setImagePreview(null);
    setIsAddingNews(false);
    setEditingNews(null);
  };

  const handleDeleteNews = async (id) => {
    if (!window.confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –Ω–æ–≤–æ—Å—Ç—å?')) {
      return;
    }

    if (!isAuthenticated) {
      alert('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
      return;
    }

    try {
      const token = localStorage.getItem('access_token');
      console.log('üóëÔ∏è –£–¥–∞–ª—è–µ–º –Ω–æ–≤–æ—Å—Ç—å ID:', id);
      
      const response = await axios.delete(`${DJANGO_API}/news/${id}/`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      console.log('‚úÖ –£–¥–∞–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ:', response.data);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
      setNewsList(newsList.filter(news => news.id !== id));
      
      // –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—É—é –Ω–æ–≤–æ—Å—Ç—å, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
      if (editingNews && editingNews.id === id) {
        resetForm();
      }
      
      alert('–ù–æ–≤–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∞!');
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
      console.error('–°—Ç–∞—Ç—É—Å:', error.response?.status);
      console.error('–î–∞–Ω–Ω—ã–µ:', error.response?.data);
      
      if (error.response?.status === 401) {
        alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.');
      } else {
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (error.response?.data?.detail || error.message));
      }
    }
  };

  const handleEditNews = (news) => {
    console.log('‚úèÔ∏è –ù–∞—á–∏–Ω–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:', news);
    setEditingNews(news);
    setFormData({
      title: news.title,
      content: news.content,
      image: null, // –ù–µ –ø–µ—Ä–µ–¥–∞–µ–º —Ñ–∞–π–ª –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
      category: news.category || "general",
      is_published: news.is_published,
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
    if (news.image_url) {
      console.log('üñºÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º preview –∏–∑ image_url:', news.image_url);
      setImagePreview(news.image_url);
    }
    
    setIsAddingNews(true);
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  const getImageUrl = (news) => {
    if (!news) {
      console.log('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–∏');
      return NewsImage;
    }
    
    console.log('üñºÔ∏è –ü–æ–ª—É—á–∞–µ–º URL –¥–ª—è –Ω–æ–≤–æ—Å—Ç–∏', news.id, ':', {
      image: news.image,
      image_url: news.image_url
    });
    
    // 1. –ò—Å–ø–æ–ª—å–∑—É–µ–º image_url –∏–∑ API –µ—Å–ª–∏ –µ—Å—Ç—å
    if (news.image_url) {
      console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º image_url:', news.image_url);
      return news.image_url;
    }
    
    // 2. –ï—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –≤ –ø–æ–ª–µ image
    if (news.image && typeof news.image === 'string') {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
      if (news.image.startsWith('http')) {
        console.log('üåê –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π URL:', news.image);
        return news.image;
      } else if (news.image.startsWith('/')) {
        const url = `http://localhost:8000${news.image}`;
        console.log('üîó –°—Ç—Ä–æ–∏–º URL –∏–∑ –ø—É—Ç–∏:', url);
        return url;
      } else if (news.image.includes('news/')) {
        const url = `${DJANGO_MEDIA}/${news.image}`;
        console.log('üìÅ –°—Ç—Ä–æ–∏–º URL –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞:', url);
        return url;
      }
    }
    
    console.log('üîÑ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É');
    return NewsImage;
  };

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤
  const checkMedia = async () => {
    try {
      const response = await axios.get(`${DJANGO_API}/news/check_media/`);
      console.log('üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ–¥–∏–∞:', response.data);
      
      alert(`üìä –°—Ç–∞—Ç—É—Å –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤:\n
–ü—É—Ç—å: ${response.data.news_path}
–°—É—â–µ—Å—Ç–≤—É–µ—Ç: ${response.data.exists ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}
–§–∞–π–ª–æ–≤: ${response.data.files_count}
–°–ø–∏—Å–æ–∫: ${response.data.files.join(', ') || '–Ω–µ—Ç —Ñ–∞–π–ª–æ–≤'}`);
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–µ–¥–∏–∞:', error);
    }
  };

  const containerStyle = {
    minHeight: '100vh',
    backgroundColor: '#f8f9fa'
  };

  const mainContentStyle = {
    flex: 1,
    padding: '20px',
    marginLeft: '250px'
  };

  // –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  const renderForm = () => (
    <form onSubmit={handleSubmit} className="p-4" style={{ backgroundColor: "#FFF4E5", borderRadius: "10px" }}>
      <div className="row mb-3">
        <div className="col-md-8">
          <label className="form-label fw-bold">–ó–∞–≥–æ–ª–æ–≤–æ–∫ *</label>
          <input
            type="text"
            className="form-control"
            name="title"
            value={formData.title}
            onChange={handleInputChange}
            required
            placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–æ–≤–æ—Å—Ç–∏"
          />
        </div>
        <div className="col-md-4">
          <label className="form-label fw-bold">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <select
            className="form-select"
            name="category"
            value={formData.category}
            onChange={handleInputChange}
            required
          >
            <option value="general">–û–±—â–∏–µ</option>
            <option value="updates">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è</option>
            <option value="promotions">–ê–∫—Ü–∏–∏</option>
            <option value="tech">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</option>
          </select>
        </div>
      </div>

      <div className="mb-3">
        <label className="form-label fw-bold">–î–æ–±–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
        <div className="d-flex align-items-center gap-2 mb-2">
          <label htmlFor="imageInput" className="btn btn-warning px-4 py-2 d-flex align-items-center rounded-pill">
            <img src={PlusImageIcon} alt="–î–æ–±–∞–≤–∏—Ç—å" className="me-2" style={{ width: '16px', height: '16px' }} />
            –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
          </label>
          <input
            id="imageInput"
            type="file"
            accept="image/*"
            onChange={handleFileChange}
            style={{ display: 'none' }}
          />
          <span className="text-muted">
            {formData.image instanceof File ? formData.image.name : "–ú–µ–¥–∏–∞—Ñ–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã"}
          </span>
        </div>
        
        {/* –ü—Ä–µ–≤—å—é */}
        {imagePreview && (
          <div className="mt-2">
            <p className="text-muted small mb-1">
              {formData.image instanceof File ? '–ù–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:' : '–¢–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:'}
            </p>
            <img 
              src={imagePreview} 
              alt="–ü—Ä–µ–≤—å—é" 
              style={{ 
                maxWidth: '300px', 
                maxHeight: '200px', 
                objectFit: 'contain',
                border: '1px solid #ddd',
                borderRadius: '5px',
                backgroundColor: '#f8f9fa'
              }}
              className="img-fluid"
            />
            <p className="text-muted small mt-1">
              {formData.image instanceof File ? 
                '–ë—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä' : 
                '–¢–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö'}
            </p>
          </div>
        )}
        
        {editingNews && editingNews.image_url && !imagePreview && (
          <div className="mt-2">
            <p className="text-muted small">–¢–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</p>
            <img 
              src={editingNews.image_url} 
              alt="–¢–µ–∫—É—â–µ–µ" 
              style={{ 
                maxWidth: '300px', 
                maxHeight: '200px', 
                objectFit: 'contain',
                border: '1px solid #ddd',
                borderRadius: '5px'
              }}
              className="img-fluid"
            />
          </div>
        )}
        
        {editingNews && !editingNews.image_url && !imagePreview && (
          <div className="alert alert-info mt-2 small">
            –£ —ç—Ç–æ–π –Ω–æ–≤–æ—Å—Ç–∏ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –µ–≥–æ.
          </div>
        )}
      </div>

      <div className="mb-3">
        <div className="form-check">
          <input
            className="form-check-input"
            type="checkbox"
            name="is_published"
            id="is_published"
            checked={formData.is_published}
            onChange={handleInputChange}
          />
          <label className="form-check-label fw-bold" htmlFor="is_published">
            –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å—Ä–∞–∑—É
          </label>
        </div>
        <div className="form-text text-muted">
          –ï—Å–ª–∏ –Ω–µ –æ—Ç–º–µ—á–µ–Ω–æ, –Ω–æ–≤–æ—Å—Ç—å –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫
        </div>
      </div>

      <div className="mb-4">
        <label className="form-label fw-bold">–û–ø–∏—Å–∞–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ *</label>
        <textarea
          className="form-control"
          name="content"
          rows="6"
          value={formData.content}
          onChange={handleInputChange}
          required
          placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏..."
        />
      </div>

      <div className="d-flex justify-content-between align-items-center">
        <div>
          {editingNews && (
            <button
              type="button"
              className="btn btn-danger me-2 rounded-pill"
              onClick={() => handleDeleteNews(editingNews.id)}
            >
              –£–¥–∞–ª–∏—Ç—å
            </button>
          )}
          <button
            type="button"
            className="btn btn-secondary rounded-pill"
            onClick={resetForm}
          >
            –û—Ç–º–µ–Ω–∞
          </button>
        </div>
        <button
          type="submit"
          className="btn btn-warning px-4 rounded-pill"
          style={{ 
            backgroundColor: '#FF6F00', 
            color: 'white',
            fontWeight: 'bold'
          }}
          disabled={loading}
        >
          {loading ? (
            <>
              <span className="spinner-border spinner-border-sm me-2" />
              –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...
            </>
          ) : editingNews ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è' : '–ì–æ—Ç–æ–≤–æ'}
        </button>
      </div>
    </form>
  );

  if (isAddingNews) {
    return (
      <div className="news-page-container" style={containerStyle}>
        <Header />
        <div className="main-content-wrapper" style={{ display: 'flex', minHeight: 'calc(100vh - 56px)' }}>
          <Sidebar />
          <main className="news-content-main" style={mainContentStyle}>
            <div className="container-fluid p-4">
              {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ñ–æ—Ä–º—ã ‚Äî –ø–æ —Ü–µ–Ω—Ç—Ä—É */}
              <div className="d-flex justify-content-center align-items-center mb-4">
                <img src={NewsIcon} alt="–ù–æ–≤–æ—Å—Ç–∏" style={{ width: "32px", height: "32px" }} className="me-3" />
                <h1 className="fw-bold" style={{ color: '#886128' }}>–ù–û–í–û–°–¢–ò</h1>
              </div>

              <div className="card border-0 shadow mb-4">
                <div className="card-body">
                  <h3 className="card-title mb-4">
                    {editingNews ? "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏" : "‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –Ω–æ–≤–æ—Å—Ç–∏"}
                  </h3>
                  {renderForm()}
                </div>
              </div>
            </div>
          </main>
        </div>
      </div>
    );
  }

  return (
    <div className="news-page-container" style={containerStyle}>
      <Header />
      <div className="main-content-wrapper" style={{ display: 'flex', minHeight: 'calc(100vh - 56px)' }}>
        <Sidebar />
        <main className="news-content-main" style={mainContentStyle}>
          <div className="container-fluid py-4">
            
            {/* –ü–∞–Ω–µ–ª—å –æ—Ç–ª–∞–¥–∫–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */}
            <div className="alert alert-info mb-4">
              <div className="d-flex justify-content-between align-items-center">
                <div>
                  <h5 className="mb-1">üì∞ –°–∏—Å—Ç–µ–º–∞ –Ω–æ–≤–æ—Å—Ç–µ–π</h5>
                  <div className="small">
                    <span className="badge bg-primary me-2">React: localhost:5173</span>
                    <span className="badge bg-success me-2">Django: localhost:8000</span>
                    <span className="badge bg-secondary">–ù–æ–≤–æ—Å—Ç–µ–π: {newsList.length}</span>
                  </div>
                </div>
                <div className="d-flex gap-2">
                  <button 
                    className="btn btn-sm btn-outline-dark"
                    onClick={() => {
                      console.log('=== DEBUG INFO ===');
                      console.log('–¢–æ–∫–µ–Ω:', localStorage.getItem('access_token'));
                      console.log('–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', isAuthenticated);
                      console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', user);
                      console.log('–ù–æ–≤–æ—Å—Ç–∏:', newsList);
                      newsList.forEach((news, idx) => {
                        console.log(`–ù–æ–≤–æ—Å—Ç—å ${idx + 1}:`, {
                          id: news.id,
                          title: news.title,
                          image: news.image,
                          image_url: news.image_url
                        });
                      });
                    }}
                  >
                    –ö–æ–Ω—Å–æ–ª—å
                  </button>
                  <button 
                    className="btn btn-sm btn-outline-dark"
                    onClick={checkMedia}
                  >
                    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ–¥–∏–∞
                  </button>
                  {isAuthenticated && (
                    <button 
                      className="btn btn-sm btn-warning"
                      onClick={() => setIsAddingNews(true)}
                    >
                      + –î–æ–±–∞–≤–∏—Ç—å
                    </button>
                  )}
                </div>
              </div>
            </div>

            {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */}
            <div className="d-flex justify-content-center align-items-center mb-4">
              <div className="d-flex align-items-center">
                <img src={NewsIcon} alt="–ù–æ–≤–æ—Å—Ç–∏" style={{ width: "40px", height: "40px" }} className="me-3" />
                <h1 className="fw-bold mb-0" style={{ color: '#886128' }}>–ù–û–í–û–°–¢–ò</h1>
              </div>
            </div>

            {/* –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å" ‚Äî –Ω–∏–∂–µ –∏ —Å–ø—Ä–∞–≤–∞ */}
            {isAuthenticated && (
              <div className="d-flex justify-content-end mb-4">
                <button
                  className="btn btn-link d-flex align-items-center px-4 py-2"
                  onClick={() => setIsAddingNews(true)}
                  style={{ 
                    color: '#AA8144',
                    textDecoration: 'none',
                    fontSize: '1.1rem'
                  }}
                >
                  <img src={PlusIcon} alt="+" className="me-2" style={{ width: '20px', height: '20px' }} />
                  –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å
                </button>
              </div>
            )}

            {/* –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ */}
            {newsList.length > 0 && (
              <div className="row mb-5">
                <div className="col-lg-6 mb-4 mb-lg-0">
                  <div className="card border-0 shadow h-100">
                    <div style={{ height: '350px', overflow: 'hidden' }}>
                      <img
                        src={getImageUrl(newsList[0])}
                        alt={newsList[0].title}
                        className="w-100 h-100"
                        style={{ objectFit: 'cover' }}
                        onError={(e) => {
                          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –≥–ª–∞–≤–Ω–æ–π –Ω–æ–≤–æ—Å—Ç–∏');
                          e.target.src = NewsImage;
                          e.target.style.objectFit = 'contain';
                          e.target.style.backgroundColor = '#f8f9fa';
                        }}
                      />
                    </div>
                    <div className="card-body">
                      <h2 className="card-title fw-bold">{newsList[0].title}</h2>
                      <p className="card-text">{newsList[0].content}</p>
                      <div className="d-flex justify-content-between align-items-center mt-4">
                        <div>
                          <span className="badge bg-warning text-dark me-2">
                            {newsList[0].category === 'general' ? '–û–±—â–∏–µ' :
                             newsList[0].category === 'updates' ? '–û–±–Ω–æ–≤–ª–µ–Ω–∏—è' :
                             newsList[0].category === 'promotions' ? '–ê–∫—Ü–∏–∏' :
                             '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏'}
                          </span>
                          <small className="text-muted">{newsList[0].created_at_formatted}</small>
                        </div>
                        {/* –ê–≤—Ç–æ—Ä—Å—Ç–≤–æ —É–¥–∞–ª–µ–Ω–æ */}
                      </div>
                    </div>
                  </div>
                </div>
                
                {newsList.length > 1 && (
                  <div className="col-lg-6">
                    <div className="row g-4 h-100">
                      {newsList.slice(1, 3).map((news, idx) => (
                        <div key={news.id} className="col-12">
                          <div className="card border-0 shadow h-100">
                            <div className="row g-0 h-100">
                              <div className="col-5">
                                <div style={{ height: '150px', overflow: 'hidden' }}>
                                  <img
                                    src={getImageUrl(news)}
                                    alt={news.title}
                                    className="w-100 h-100"
                                    style={{ objectFit: 'cover' }}
                                    onError={(e) => {
                                      console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ—Å—Ç–∏ ${news.id}`);
                                      e.target.src = NewsImage;
                                      e.target.style.objectFit = 'contain';
                                      e.target.style.backgroundColor = '#f8f9fa';
                                    }}
                                  />
                                </div>
                              </div>
                              <div className="col-7">
                                <div className="card-body h-100 d-flex flex-column">
                                  <h5 className="card-title fw-bold">{news.title}</h5>
                                  <p className="card-text small flex-grow-1">
                                    {news.content.substring(0, 100)}...
                                  </p>
                                  <div className="d-flex justify-content-between align-items-center mt-2">
                                    <small className="text-muted">
                                      {news.category === 'general' ? '–û–±—â–∏–µ' :
                                       news.category === 'updates' ? '–û–±–Ω–æ–≤–ª–µ–Ω–∏—è' :
                                       news.category === 'promotions' ? '–ê–∫—Ü–∏–∏' :
                                       '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏'}
                                    </small>
                                    {/* –ê–≤—Ç–æ—Ä—Å—Ç–≤–æ —É–¥–∞–ª–µ–Ω–æ */}
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* –õ–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π */}
            <div className="mt-5">
              <div className="d-flex justify-content-center align-items-center mb-4">
                <h3 className="fw-bold mb-0" style={{ 
                  color: '#886128', 
                  backgroundColor: '#F9E5C8', 
                  padding: '10px 20px', 
                  borderRadius: '5px',
                  width: '100%',
                  textAlign: 'center'
                }}>
                  –õ–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π
                </h3>
              </div>
              
              {loading ? (
                <div className="text-center py-5">
                  <div className="spinner-border text-warning" style={{ width: '3rem', height: '3rem' }} />
                  <p className="mt-3">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π...</p>
                </div>
              ) : newsList.length === 0 ? (
                <div className="text-center py-5">
                  <div className="display-1 text-muted mb-4">üì∞</div>
                  <h4 className="text-muted mb-3">–ù–æ–≤–æ—Å—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</h4>
                  <p className="text-muted mb-4">–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –¥–æ–±–∞–≤–∏—Ç –Ω–æ–≤–æ—Å—Ç—å!</p>
                  {isAuthenticated && (
                    <button
                      className="btn btn-warning px-4 py-2"
                      onClick={() => setIsAddingNews(true)}
                    >
                      <i className="bi bi-plus-lg me-2" />
                      –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é –Ω–æ–≤–æ—Å—Ç—å
                    </button>
                  )}
                </div>
              ) : (
                <div className="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4">
                  {newsList.map((news) => (
                    <div key={news.id} className="col">
                      <div className="card h-100 border-0 shadow-sm hover-shadow">
                        <div 
                          style={{ 
                            height: '200px', 
                            overflow: 'hidden',
                            position: 'relative',
                            backgroundColor: '#f8f9fa'
                          }}
                        >
                          <img
                            src={getImageUrl(news)}
                            alt={news.title}
                            className="w-100 h-100"
                            style={{ 
                              objectFit: 'cover',
                              transition: 'transform 0.3s ease'
                            }}
                            onError={(e) => {
                              console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ—Å—Ç–∏ ${news.id}`);
                              e.target.src = NewsImage;
                              e.target.style.objectFit = 'contain';
                              e.target.style.padding = '20px';
                            }}
                            onMouseEnter={(e) => e.target.style.transform = 'scale(1.05)'}
                            onMouseLeave={(e) => e.target.style.transform = 'scale(1)'}
                          />
                          {isAuthenticated && (
                            <button
                              className="position-absolute top-0 end-0 m-2 btn btn-light btn-sm shadow rounded-circle"
                              onClick={() => handleEditNews(news)}
                              title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                              style={{ 
                                backdropFilter: 'blur(5px)'
                              }}
                            >
                              ‚úèÔ∏è
                            </button>
                          )}
                        </div>
                        <div className="card-body d-flex flex-column">
                          <h6 className="card-title fw-bold">{news.title}</h6>
                          <p className="card-text small text-muted flex-grow-1">
                            {news.content.length > 120 ? `${news.content.substring(0, 120)}...` : news.content}
                          </p>
                          <div className="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                            <div>
                              <span className="badge bg-light text-dark me-2">
                                {news.category === 'general' ? '–û–±—â–∏–µ' :
                                 news.category === 'updates' ? '–û–±–Ω–æ–≤–ª–µ–Ω–∏—è' :
                                 news.category === 'promotions' ? '–ê–∫—Ü–∏–∏' :
                                 '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏'}
                              </span>
                              <small className="text-muted">{news.created_at_formatted}</small>
                            </div>
                            {/* –ê–≤—Ç–æ—Ä—Å—Ç–≤–æ —É–¥–∞–ª–µ–Ω–æ */}
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </main>
      </div>
    </div>
  );
};

export default NewsPage;